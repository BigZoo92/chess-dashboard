services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-chess_stats}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - db-data:/var/lib/postgresql/data

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: prod
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@db:5432/chess_stats?schema=public}
      API_PORT: ${API_PORT:-3001}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://chess-dashboard.enzogivernaud.fr}
      CHESSCOM_USERNAME: ${CHESSCOM_USERNAME:-}
      CHESSCOM_USER_AGENT: "${CHESSCOM_USER_AGENT:-ecoconception-chess-dashboard (contact: you@email.com)}"
      SYNC_CONCURRENCY: ${SYNC_CONCURRENCY:-1}
      SYNC_MAX_MONTHS: ${SYNC_MAX_MONTHS:-36}
      SYNC_RATE_LIMIT_MS: ${SYNC_RATE_LIMIT_MS:-300}
      NODE_ENV: production
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "3001"
    # Optionnel : garde-le seulement si tu veux appeler l'API depuis l'extérieur (debug, etc.)
    ports:
      - "3001:3001"

  web:
    build:
      context: .
      dockerfile: apps/proxy/Dockerfile
      args:
        VITE_API_URL: ""
        VITE_BASE_PATH: /dashboard/
        VITE_ROUTER_BASENAME: /dashboard
        PUBLIC_SITE_URL: ${PUBLIC_SITE_URL:-https://chess-dashboard.enzogivernaud.fr}
    depends_on:
      - api
    # IMPORTANT : c'est un Caddy, il écoute sur 80 dans le container
    expose:
      - "80"
    # Optionnel : garde-le si tu veux tester sans Traefik (curl localhost:8080)
    ports:
      - "8080:80"

volumes:
  db-data:
